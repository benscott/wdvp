<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">

    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="http://d3js.org/topojson.v1.min.js"></script>
    <script src="http://d3js.org/queue.v1.min.js"></script>
    <script src="js/d3-legend.js"></script>
    <script src="d3-scale-radial.js"></script>
    <script src="./globe.js"></script>
    <script src="./stacked-bar-chart.js"></script>
    <link rel="stylesheet" href="css/styles.css">

</head>

<body>

    <div id="info-box">
        <h1>A world of happiness</h1>
    </div>
    <div>
        <svg width="700" height="700"></svg>
    </div>

    <script>
        var dataset;

        var svg = d3.select("svg"),
            innerRadius = 120;

        var globe = new Globe(svg, innerRadius - 2)
        var bar = new StackedBarChart(svg, innerRadius)

        function highlightCountry(d) {
            d3.selectAll('.highlight').classed("highlight", false);
            d3.selectAll('.country-' + d.id).classed("highlight", true);
        }

        function unHighlightCountry(d) {
            d3.selectAll('.highlight').classed("highlight", false);
        }

        function rotateMapToCentroid(centroid) {
            globe.rotateToCentroid(centroid);
        }

        queue()
            .defer(d3.json, "./data/world-110m.json")
            .defer(d3.tsv, "./data/world-110m-country-names.tsv")
            .defer(d3.csv, "./data/whr-data.csv")
            .await(ready);

        function ready(error, worldTopologyData, countryNamesData, worldHappinessData) {

            // Just throw an error if there's a problem
            if (error) throw error;

            dataset = topojson.feature(worldTopologyData, worldTopologyData.objects.countries).features;

            // Amalgamate all the data into one dataset
            countryNamesByID = {}
            countryNamesData.forEach(function (d) {
                countryNamesByID[d.id] = d.name;
            });

            worldHappinessByName = {}
            worldHappinessData.forEach(function (d, i) {
                d['rank'] = i;
                worldHappinessByName[d['Country']] = d
            });

            dataset.explainedByColumns = worldHappinessData.columns.splice(2)

            var countryName, countryHappiness
            dataset.forEach(function (d, i) {
                countryName = countryNamesByID[d.id];
                countryHappiness = worldHappinessByName[countryName];
                dataset[i]['properties']['name'] = countryName;
                dataset[i]['properties']['centroid'] = d3.geoCentroid(d);

                if (typeof (countryHappiness) !== 'undefined') {
                    dataset[i]['properties']['happinessScore'] = parseFloat(countryHappiness['Happiness score']);
                    dataset[i]['properties']['rank'] = parseFloat(countryHappiness['rank']) + 1;
                    var total = 0;
                    dataset.explainedByColumns.forEach(function (column) {
                        dataset[i]['properties'][column] = parseFloat(countryHappiness[column]);
                        total += dataset[i]['properties'][column];
                    });
                    dataset[i]['properties']['explainedByTotal'] = total
                }
            });

            globe.draw()
            bar.draw()


        }



    </script>



</body>




</html>